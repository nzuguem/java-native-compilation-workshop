name: Quarkus Application CI Workflow

on:
  push:
    branches:
      - main
    paths:
      - 03-quarkus/**
      - .github/workflows/quarkus.yml
      - .github/workflows/native-image.yml

jobs:
  build-native-image-and-container-image:
    name: Build and package Quarkus Application
    uses: ./.github/workflows/native-image.yml
    with:
      app-name: quarkus-native
      app-path: 03-quarkus
      app-native-image-path: target
      app-native-image-name: '*-runner'

  deploy-on-aws:
    name: ‚òÅÔ∏è Deploy Application on AWS Lambda
    runs-on: ubuntu-latest
    environment: AWS
    needs:
      - build-native-image-and-container-image
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: quarkus-native
          path: 03-quarkus/target

      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: üîç Validate AWS SAM Template
        run: sam validate --lint -t 03-quarkus/template.gha.yml

      - name: üöÄ AWS SAM Deploy
        run: |
          cd 03-quarkus
          mkdir -p gha/aws
          cp target/quarkus-native-1.0-runner gha/aws/hello
          cp src/main/resources/bootstrap gha/aws/bootstrap
          chmod 777 gha/aws/hello
          chmod 777 gha/aws/bootstrap
          sam deploy -t template.gha.yml
